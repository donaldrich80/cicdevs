include:
  - project: donaldrich/modular-gitlab-ci
    file: templates/default.yml
  - local: .meta/pipelines.gitlab-ci.yml
  - project: donaldrich/modular-gitlab-ci
    file: function/repo/auto-push.yml

cache:
  untracked: true
  paths:
    - .meta/snippets

stages:
  - pre
  - lint
  - debug
  - builder
  - dependency
  - fetch-version
  - build
  - release
  - push
  - deploy
  - documentation
  - post

variables:
  DISABLE_LINTING: "true"
  DISABLE_SAST: "true"
  DISABLE_GOSS: "true"
  PUSHOVER_ID: $CI_PROJECT_TITLE


fetch-semantic-version:
  image:
    name: donaldrich/function:semantic-release
    entrypoint: [""]
  stage: fetch-version
  only:
    refs:
    - master
    # - alpha
    # - /^(([0-9]+)\.)?([0-9]+)\.x/ # This matches maintenance branches
    # - /^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/ # This matches pre-releases
  script:
    # - npm install @semantic-release/gitlab @semantic-release/exec
    # - npm install @semantic-release/gitlab @semantic-release/exec
    - npx semantic-release --generate-notes false --dry-run
  artifacts:
    paths:
      - VERSION.txt

generate-non-semantic-version:
  stage: fetch-version
  except:
    refs:
    - master
    - alpha
    - /^(([0-9]+)\.)?([0-9]+)\.x/ # This matches maintenance branches
    - /^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/ # This matches pre-releases
  script:
    - echo build-$CI_PIPELINE_ID > VERSION.txt
  artifacts:
    paths:
      - VERSION.txt

build:
  stage: build
  script:
    - echo "Version is $(cat VERSION.txt)"


release:
  image:
    name: donaldrich/function:semantic-release
    entrypoint: [""]
  stage: release
  only:
    refs:
    - master
    # - alpha
    # # This matches maintenance branches
    # - /^(([0-9]+)\.)?([0-9]+)\.x/
    # # This matches pre-releases
    # - /^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
  script:
    # - npm install @semantic-release/gitlab
    - npx semantic-release