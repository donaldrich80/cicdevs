FROM ubuntu:eoan as builder-base
# Required by Docker
ENV DEBIAN_FRONTEND noninteractive

ENV \
    # Docker
    DOCKER_VERSION=18.03 \
    DIND_COMMIT=52379fa76dee07ca038624d639d9e14f4fb719ff \
    # Docker Compose
    DOCKER_COMPOSE_VERSION=1.25.5 \
    DOCKER_COMPOSE_SHA256=1cb7ecccc17c8d5f1888f9e2b3211b07e35c86d0010a6c0f711fe65ef5b69528 \
    # Docker Machine
    DOCKER_MACHINE_VERSION=0.15.0 \
    DOCKER_MACHINE_SHA256=44c5c62db13b6eb6a9d3e276c1181401c78327ff6303570936ba2cf5d137b7b5 \
    DOCKER_SLIM_VERSION=1.29.0 \
    BUILDX_VERSION=0.3.1

RUN apt-get update \
    && apt-get -y install \
        ca-certificates \
        apt-transport-https \
        software-properties-common \
        upx-ucl \
        curl \
        wget \
        openssl

# FROM builder-base as machine
# # Install Docker Machine
# RUN wget "https://github.com/docker/machine/releases/download/v${DOCKER_MACHINE_VERSION}/docker-machine-Linux-x86_64" -O /usr/local/bin/docker-machine \
#     && echo "${DOCKER_MACHINE_SHA256} */usr/local/bin/docker-machine" | sha256sum -c - \
#     && upx /usr/local/bin/docker-machine \
#     && chmod +x /usr/local/bin/docker-machine

FROM builder-base as buildx
RUN mkdir -p /tmp/.docker/cli-plugins/ \
    && wget -O /tmp/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v${BUILDX_VERSION}/buildx-v${BUILDX_VERSION}.linux-amd64  \
    && chmod a+x /tmp/.docker/cli-plugins/docker-buildx \
    && upx /tmp/.docker/cli-plugins/docker-buildx
    # && docker buildx install

FROM builder-base as hadolint
COPY --from=hadolint/hadolint:latest /bin/hadolint /bin/hadolint


RUN apk add --no-cache --virtual build-dependencies python3-dev libffi-dev openssl-dev gcc libc-dev make \
    && pip3 install "docker-compose${DOCKER_COMPOSE_VERSION:+==}${DOCKER_COMPOSE_VERSION}" \
    && apk del build-dependencies

RUN mkdir -p ~/.docker/cli-plugins/ \
    && wget -O ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v${BUILDX_VERSION}/buildx-v${BUILDX_VERSION}.linux-amd64  \
    && chmod a+x ~/.docker/cli-plugins/docker-buildx \
    && docker buildx install


ENV DOCKER_CLI_EXPERIMENTAL=enabled
ENV BUILDKIT_HOST=tcp://0.0.0.0:1234
ENV DOCKER_BUILDKIT=1
